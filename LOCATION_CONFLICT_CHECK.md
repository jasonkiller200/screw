# 倉位衝突檢查功能說明

## 功能概述

當新增或編輯零件時，系統會**自動檢查倉位是否已被其他零件使用**。如果倉位已被佔用，系統會：

✅ **顯示詳細警告訊息**  
✅ **禁止保存零件**  
✅ **列出使用該倉位的所有零件**

## 使用場景

### 場景 1：新增零件時的倉位衝突

**操作：**
1. 新增零件：螺絲-M8x30
2. 選擇倉庫：主倉庫
3. 輸入倉位：A區-1層-1排（已被其他零件使用）
4. 點擊「新增零件」

**系統反應：**
```
⚠️ 倉位衝突！以下倉位已被其他零件使用：

• 主倉庫 - A區-1層-1排
  使用中的零件: 030200332800 - 保護膜_50*50cm (黑色), 0499002171 - 酒精清潔液_4000ml

❌ 零件未被保存
```

### 場景 2：編輯零件時的倉位衝突

**操作：**
1. 編輯現有零件
2. 修改或新增倉位：B區-2層-3排（已被其他零件使用）
3. 點擊「更新零件」

**系統反應：**
```
⚠️ 倉位衝突！以下倉位已被其他零件使用：

• 主倉庫 - B區-2層-3排
  使用中的零件: 010600022500 - 油漆刷_1"

❌ 零件更新失敗
```

### 場景 3：同一零件編輯自己的倉位

**操作：**
1. 編輯零件A（目前使用：C區-1層-1排）
2. 保持倉位不變：C區-1層-1排
3. 修改其他欄位（名稱、描述等）
4. 點擊「更新零件」

**系統反應：**
```
✅ 零件更新成功
```

**說明：** 編輯時會排除自己目前使用的倉位，不會與自己衝突。

## 技術實現

### 檢查邏輯

```python
# 新增零件時
for each 倉位 in 輸入的倉位列表:
    if 倉位已存在:
        查詢使用此倉位的零件
        if 有其他零件使用:
            記錄衝突
            列出零件清單

if 有任何衝突:
    返回錯誤
    顯示衝突詳情
    禁止保存
else:
    允許保存
```

```python
# 編輯零件時
for each 倉位 in 輸入的倉位列表:
    if 倉位已存在:
        查詢使用此倉位的零件（排除當前零件）
        if 有其他零件使用:
            記錄衝突
            列出零件清單

if 有任何衝突:
    返回錯誤
    顯示衝突詳情
    禁止更新
else:
    允許更新
```

## 測試結果

```
======================================================================
測試：倉位衝突檢查功能
======================================================================

步驟 1：創建第一個零件使用倉位 'TEST-衝突測試-A1'
✓ 第一個零件創建成功

步驟 2：嘗試創建第二個零件使用相同倉位 'TEST-衝突測試-A1'
✓ 第二個零件被阻止創建
  錯誤類型: location_conflict

  ⚠️  倉位衝突警告:
    倉庫: 主倉庫
    倉位: TEST-衝突測試-A1
    使用中的零件:
      - TEST-PART-001 - 測試零件A

======================================================================
測試結果：
  ✅ 倉位衝突檢查功能正常運作
  ✅ 當倉位已被其他零件使用時，會顯示警告
  ✅ 新增零件會被阻止，保護倉位唯一性
======================================================================
```

## 警告訊息格式

### 單個倉位衝突
```
倉位衝突！以下倉位已被其他零件使用：

• 主倉庫 - A區-1層-1排
  使用中的零件: 030200332800 - 保護膜_50*50cm (黑色)
```

### 多個倉位衝突
```
倉位衝突！以下倉位已被其他零件使用：

• 主倉庫 - A區-1層-1排
  使用中的零件: 030200332800 - 保護膜_50*50cm (黑色)

• 副倉庫 - B區-2層-3排
  使用中的零件: 0499002171 - 酒精清潔液_4000ml, 010600022500 - 油漆刷_1"
```

### 多個零件使用同一倉位
```
• 主倉庫 - A區-1層-1排
  使用中的零件: Part-001 - 零件A, Part-002 - 零件B, Part-003 - 零件C 等 5 個零件
```

## 返回值結構

### 成功情況
```python
{
    'success': True
}
```

### 失敗情況 - 零件編號重複
```python
{
    'success': False,
    'error': '零件編號已存在'
}
```

### 失敗情況 - 倉位衝突
```python
{
    'success': False,
    'error': 'location_conflict',
    'conflicts': [
        {
            'warehouse': '主倉庫',
            'location': 'A區-1層-1排',
            'parts': [
                '030200332800 - 保護膜_50*50cm (黑色)',
                '0499002171 - 酒精清潔液_4000ml'
            ]
        }
    ]
}
```

## 設計考量

### 為什麼需要倉位衝突檢查？

1. **防止倉位混亂**：確保每個倉位只存放一種零件
2. **方便盤點**：盤點時可以確定倉位內的零件種類
3. **減少錯誤**：避免拿錯零件
4. **倉儲管理**：符合標準倉儲管理規範

### 特殊情況處理

#### 1. 一個零件可以有多個倉位
✅ **允許**：一種零件可以存放在多個不同的倉位

```
零件A:
  - 主倉庫 - A區-1層-1排
  - 副倉庫 - B區-2層-2排
  - 工具倉 - T1區-1排
```

#### 2. 一個倉位只能存放一種零件
✅ **限制**：同一個倉位不能同時存放多種零件

```
主倉庫 - A區-1層-1排:
  ✅ 可以: 零件A
  ❌ 不可: 零件A + 零件B
```

#### 3. 編輯時不與自己衝突
✅ **智能判斷**：編輯零件時，系統會排除自己目前使用的倉位

```
編輯零件A（目前使用: A區-1層-1排）
修改倉位為: A區-1層-1排（保持不變）
結果: ✅ 允許更新（不算衝突）
```

## 程式碼位置

- **檢查邏輯**：`models/part.py`
  - `Part.create()` 方法（第 143-228 行）
  - `Part.update()` 方法（第 230-323 行）

- **錯誤處理**：`controllers/web_controller.py`
  - 新增零件（第 95-120 行）
  - 編輯零件（第 159-179 行）

## 如何停用檢查（如果需要）

如果您的倉庫管理允許一個倉位存放多種零件，可以註解掉檢查代碼：

```python
# 在 models/part.py 中註解這段代碼
# 檢查倉位衝突
# location_conflicts = []
# if locations_data:
#     ... (檢查邏輯)

# if location_conflicts:
#     return {
#         'success': False, 
#         'error': 'location_conflict',
#         'conflicts': location_conflicts
#     }
```

## 總結

✅ **自動檢查**：新增/編輯零件時自動檢查倉位衝突  
✅ **詳細警告**：顯示衝突的倉位和使用中的零件  
✅ **禁止保存**：有衝突時禁止保存，保護資料完整性  
✅ **智能判斷**：編輯時排除自己，避免誤判  
✅ **靈活配置**：可以根據需求啟用或停用檢查

這個功能確保了倉位管理的唯一性和準確性，符合標準倉儲管理最佳實踐。
