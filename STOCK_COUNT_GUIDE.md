# 盤點功能完整指南

## 盤點流程概覽

```
1. 建立盤點 (Planning)
   ↓
2. 開始盤點 (Counting)
   ↓
3. 輸入實盤數量
   ↓
4. 完成盤點 (Completed)
   ↓
5. 調整庫存（可選）
```

## 盤點類型說明

### 1. 全盤點 (Full Count)
**用途：** 盤點倉庫內所有零件

**特點：**
- ✅ 系統自動載入該倉庫所有有庫存的零件
- ✅ 最全面的盤點方式
- ✅ 適合月底、年底盤點

**操作流程：**
1. 選擇「全盤點」
2. 選擇要盤點的倉庫
3. 系統自動產生該倉庫所有零件的盤點清單
4. 逐一輸入實盤數量

**範例：**
```
倉庫：主倉庫
類型：全盤點
盤點項目：該倉庫所有零件（例如：500 項）
```

### 2. 循環盤點 (Cycle Count)
**用途：** 定期輪流盤點部分零件

**特點：**
- ✅ 減少工作量
- ✅ 可以按 ABC 分類輪流盤點
- ✅ 適合日常盤點

**操作流程：**
1. 選擇「循環盤點」
2. 選擇要盤點的倉庫
3. 系統產生該倉庫的零件清單
4. 可以從 CSV 範本匯入要盤點的零件
5. 輸入實盤數量

**範例：**
```
倉庫：主倉庫
類型：循環盤點
本周盤點：A類零件（高價值）
下周盤點：B類零件（中價值）
```

### 3. 抽點 (Spot Check)
**用途：** 隨機抽查部分零件

**特點：**
- ✅ 快速驗證
- ✅ 重點檢查可疑項目
- ✅ 適合稽核使用

**操作流程：**
1. 選擇「抽點」
2. 選擇要盤點的倉庫
3. 手動選擇或匯入要盤點的零件
4. 輸入實盤數量

**範例：**
```
倉庫：主倉庫
類型：抽點
盤點項目：隨機抽選 50 項零件
```

## 完整操作流程

### 步驟 1：建立盤點

**路徑：** 庫存管理 → 盤點管理 → 建立新盤點

**操作：**
1. 選擇倉庫（必填）
2. 選擇盤點類型（必填）
   - 全盤點
   - 循環盤點
   - 抽點
3. 選擇盤點日期（必填）
4. 輸入盤點人員（選填）
5. 輸入備註說明（選填）
6. 點擊「建立盤點」

**API：** `POST /api/inventory/stock-counts/create`

```json
{
    "warehouse_id": 1,
    "count_type": "full",
    "count_date": "2025-10-15",
    "counted_by": "張三",
    "notes": "月底全盤"
}
```

**結果：**
- ✅ 系統產生盤點編號（例如：SC-20251015-1234）
- ✅ 狀態設為「規劃中」
- ✅ 根據盤點類型載入零件清單

### 步驟 2：開始盤點

**路徑：** 盤點詳情頁面 → 開始盤點按鈕

**操作：**
1. 進入盤點詳情頁面
2. 檢查盤點清單是否正確
3. 點擊「開始盤點」按鈕

**API：** `POST /api/inventory/stock-counts/{count_id}/start`

**結果：**
- ✅ 狀態變更為「盤點中」
- ✅ 記錄開始時間
- ✅ 可以開始輸入實盤數量

### 步驟 3：輸入實盤數量

**方式 1：線上輸入（推薦）**

1. 在盤點詳情頁面
2. 逐項輸入實盤數量
3. 系統自動計算差異
4. 可輸入備註說明

**欄位說明：**
- **零件編號**：系統自動填入
- **零件名稱**：系統自動填入
- **系統數量**：盤點時的系統庫存
- **實盤數量**：✏️ 手動輸入
- **差異**：自動計算（實盤 - 系統）
- **差異率**：自動計算（差異 / 系統 × 100%）
- **備註**：✏️ 可輸入異常說明

**方式 2：匯入 CSV（適合大量盤點）**

1. 下載盤點範本（CSV）
2. 在 Excel 中填寫實盤數量
3. 上傳 CSV 檔案
4. 系統批量更新

**CSV 格式：**
```csv
part_number,part_name,unit,system_quantity,counted_quantity,notes
030200332800,保護膜_50*50cm,個,100,98,損壞2個
0499002171,酒精清潔液_4000ml,瓶,50,50,
```

### 步驟 4：完成盤點

**路徑：** 盤點詳情頁面 → 完成盤點按鈕

**操作：**
1. 確認所有項目已盤點完成
2. 點擊「完成盤點」按鈕
3. 系統產生盤點報告

**API：** `POST /api/inventory/stock-counts/{count_id}/complete`

**結果：**
- ✅ 狀態變更為「已完成」
- ✅ 記錄完成時間
- ✅ 統計差異項目數量
- ✅ 產生盤點報告

### 步驟 5：調整庫存（可選）

**說明：** 根據盤點結果調整系統庫存

**操作：**
1. 在盤點詳情頁面
2. 查看有差異的項目
3. 點擊「調整庫存」按鈕
4. 系統自動調整庫存為實盤數量

**調整邏輯：**
```
如果 實盤數量 > 系統數量：
    → 執行入庫調整（盤盈）
如果 實盤數量 < 系統數量：
    → 執行出庫調整（盤虧）
如果 實盤數量 = 系統數量：
    → 無需調整
```

**交易記錄：**
- 交易類型：「盤點調整」
- 數量：差異數量
- 來源：盤點編號
- 備註：自動註記

## 盤點狀態說明

| 狀態 | 英文 | 說明 | 可執行操作 |
|------|------|------|-----------|
| 規劃中 | planning | 已建立盤點，尚未開始 | 開始盤點、編輯、刪除 |
| 盤點中 | counting | 正在進行盤點 | 輸入數量、完成盤點 |
| 已完成 | completed | 盤點完成 | 查看報告、調整庫存 |
| 已調整 | adjusted | 已根據盤點調整庫存 | 查看報告 |

## API 端點總覽

### 建立和管理盤點

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/inventory/stock-counts/create` | POST | 建立新盤點 |
| `/api/inventory/stock-counts/{id}/start` | POST | 開始盤點 |
| `/api/inventory/stock-counts/{id}/complete` | POST | 完成盤點 |
| `/api/inventory/stock-counts/{id}/cancel` | POST | 取消盤點 |

### 盤點明細

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/inventory/stock-counts/{id}/items` | GET | 取得盤點明細 |
| `/api/inventory/stock-counts/{id}/items/{item_id}` | PUT | 更新盤點項目 |
| `/api/inventory/stock-counts/{id}/import` | POST | 匯入盤點結果 |

### 報告和導出

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/inventory/stock-counts/{id}/report` | GET | 取得盤點報告 |
| `/api/inventory/stock-counts/{id}/export` | GET | 導出盤點結果 |
| `/api/inventory/stock-counts/{id}/template` | GET | 下載盤點範本 |

## 盤點報告內容

### 基本資訊
- 盤點編號
- 倉庫名稱
- 盤點類型
- 盤點日期
- 盤點人員
- 狀態

### 統計資訊
- 總盤點項目數
- 已盤點項目數
- 盤盈項目數（實盤 > 系統）
- 盤虧項目數（實盤 < 系統）
- 一致項目數（實盤 = 系統）

### 差異分析
- 最大盤盈項目
- 最大盤虧項目
- 總盤盈數量
- 總盤虧數量
- 差異金額（如有成本資料）

## 實際操作範例

### 範例 1：月底全盤點

**情境：** 月底對主倉庫進行全盤點

**步驟：**
```
1. 建立盤點
   - 倉庫：主倉庫
   - 類型：全盤點
   - 日期：2025-10-31
   - 盤點人：張三

2. 系統自動產生清單
   - 載入主倉庫所有零件（500項）
   - 記錄當前系統數量

3. 開始盤點
   - 點擊「開始盤點」
   - 狀態變更為「盤點中」

4. 現場盤點
   - 逐項清點實物數量
   - 線上輸入或使用條碼掃描器
   - 發現異常時輸入備註

5. 完成盤點
   - 確認全部盤點完成
   - 點擊「完成盤點」
   - 查看差異報告

6. 調整庫存
   - 審核差異項目
   - 確認後點擊「調整庫存」
   - 系統自動更新庫存
```

### 範例 2：ABC 循環盤點

**情境：** 每周盤點高價值零件（A類）

**步驟：**
```
1. 建立循環盤點
   - 倉庫：主倉庫
   - 類型：循環盤點
   - 本周盤點：A類零件（50項）

2. 選擇盤點項目
   - 匯入預先準備的 A類零件清單
   - 或手動選擇高價值零件

3. 進行盤點
   - 重點清點這 50 項零件
   - 輸入實盤數量

4. 完成並分析
   - 完成盤點
   - 如有差異立即調查
   - 調整庫存
```

### 範例 3：稽核抽點

**情境：** 稽核人員隨機抽查

**步驟：**
```
1. 建立抽點
   - 倉庫：主倉庫
   - 類型：抽點
   - 隨機選取 20 項零件

2. 現場抽查
   - 不預先通知
   - 快速盤點選定項目

3. 結果分析
   - 檢查差異率
   - 如差異過大需進一步調查
```

## 常見問題

### Q1：盤點時可以繼續出入庫嗎？

**A：** 建議盤點時暫停該倉庫的出入庫作業，避免數據不一致。如需繼續作業：
- 盤點前記錄「系統數量」為盤點基準
- 完成盤點後考慮此期間的交易記錄

### Q2：盤點後發現輸入錯誤怎麼辦？

**A：** 
- 如盤點狀態為「盤點中」：可直接修改
- 如已「完成盤點」但未調整庫存：可重新開始盤點
- 如已「調整庫存」：建議建立新盤點重新確認

### Q3：如何選擇盤點類型？

**A：**
- **全盤點**：月底、年底、重要時點
- **循環盤點**：日常持續盤點，減少工作量
- **抽點**：稽核、重點檢查、快速驗證

### Q4：盤點差異很大怎麼辦？

**A：**
1. 先不調整庫存
2. 調查差異原因：
   - 盤點錯誤？
   - 未登記交易？
   - 實物錯放？
3. 確認原因後再決定是否調整

### Q5：可以同時進行多個盤點嗎？

**A：** 可以，但建議：
- 不同倉庫可同時盤點
- 同一倉庫避免同時多個盤點
- 注意避免資源衝突

## 最佳實踐

### 1. 定期盤點
- 設定固定盤點周期
- A類零件：每月
- B類零件：每季
- C類零件：每半年

### 2. 盤點前準備
- ✅ 整理倉庫，標示清楚
- ✅ 準備盤點工具（掃描器、平板等）
- ✅ 列印盤點清單
- ✅ 通知相關人員

### 3. 盤點時注意
- ✅ 兩人一組，互相核對
- ✅ 發現異常立即標註
- ✅ 拍照記錄可疑項目
- ✅ 不遺漏角落位置

### 4. 盤點後處理
- ✅ 立即分析差異原因
- ✅ 記錄處理措施
- ✅ 更新作業流程
- ✅ 檢討改善機會

## 總結

盤點功能支援三種盤點類型，完整的流程從建立、開始、輸入、完成到調整，每個步驟都有對應的 API 和介面操作。透過靈活運用不同盤點類型，可以建立有效的庫存管理機制。

**關鍵步驟：**
1. ✅ 建立盤點（選擇類型和倉庫）
2. ✅ 開始盤點（進入盤點狀態）
3. ✅ 輸入數量（線上或匯入 CSV）
4. ✅ 完成盤點（產生報告）
5. ✅ 調整庫存（可選，更新系統庫存）

**支援功能：**
- ✅ 三種盤點類型（全盤點、循環盤點、抽點）
- ✅ 線上輸入或 CSV 批量匯入
- ✅ 自動計算差異和差異率
- ✅ 完整的狀態管理
- ✅ 盤點報告和分析
- ✅ 庫存調整功能
