# 盤點結果匯入功能使用指南（Excel 版本）

## 📊 重要更新

**檔案格式已改為 Excel (.xlsx)**
- ✅ 不會有編碼問題
- ✅ 不會有資料跑掉的問題
- ✅ 直接用 Excel 編輯和儲存
- ✅ 欄位自動調整大小
- ✅ 黃色標示待填欄位

## 功能位置

**路徑：** 庫存管理 → 盤點管理 → 選擇盤點 → 盤點詳情

**按鈕位置：** 盤點明細卡片右上角

```
┌────────────────────────────────────────────┐
│ 盤點明細                                   │
│                  [匯入盤點結果] [匯出資料] │
├────────────────────────────────────────────┤
│ 盤點項目列表...                            │
└────────────────────────────────────────────┘
```

**顯示條件：** 只有「盤點中」狀態才會顯示匯入按鈕

## 完整操作流程

### 步驟 1：匯出盤點範本 ✨

1. 進入盤點詳情頁面
2. 點擊「匯出資料」按鈕
3. 下載 **Excel 檔案**（.xlsx）

**檔案特色：**
- ✅ 標題行：藍色背景，白色粗體字
- ✅ 欄位寬度：自動調整
- ✅ 待填欄位：黃色背景標示
- ✅ 凍結首行：方便捲動查看
- ✅ 格線邊框：清楚易讀

**Excel 範例：**
```
┌──────────────┬──────────────┬──────┬────────┬────────┬──────┐
│ 零件編號     │ 零件名稱     │ 單位 │系統數量│實盤數量│ 備註 │
├──────────────┼──────────────┼──────┼────────┼────────┼──────┤
│ 030200332800 │保護膜_50*50cm│  個  │  100   │ [黃色] │      │
│ 0499002171   │酒精清潔液    │  瓶  │   50   │ [黃色] │      │
└──────────────┴──────────────┴──────┴────────┴────────┴──────┘
```

### 步驟 2：填寫盤點結果 ✏️

1. **直接用 Excel 開啟下載的檔案**
2. **填寫「實盤數量」欄位**（黃色背景提示）
   - 這是唯一需要填寫的必填欄位
   - 填入實際盤點的數量
   - 黃色背景會自動消失

3. **填寫「備註」欄位（選填）**
   - 如有異常可以記錄
   - 例如：損壞、過期、位置錯誤等

**填寫範例：**
```
┌──────────────┬──────────────┬──────┬────────┬────────┬──────────┐
│ 零件編號     │ 零件名稱     │ 單位 │系統數量│實盤數量│ 備註     │
├──────────────┼──────────────┼──────┼────────┼────────┼──────────┤
│ 030200332800 │保護膜_50*50cm│  個  │  100   │   98   │ 損壞2個  │
│ 0499002171   │酒精清潔液    │  瓶  │   50   │   50   │          │
│ 010600022500 │油漆刷_1"     │  支  │   30   │   28   │ 2支遺失  │
└──────────────┴──────────────┴──────┴────────┴────────┴──────────┘
```

### 步驟 3：儲存 Excel 檔案 💾

**超簡單！直接儲存即可：**
- ✅ 點擊「儲存」或 Ctrl+S
- ✅ 保持 Excel 格式 (.xlsx)
- ✅ 不需要另存為其他格式
- ✅ 不需要擔心編碼問題

**不要做：**
- ❌ 不要另存為 CSV
- ❌ 不要改變欄位順序
- ❌ 不要刪除標題行

### 步驟 4：上傳匯入 📤

1. **點擊「匯入盤點結果」按鈕**
2. **選擇剛才儲存的 Excel 檔案**
3. **點擊「開始匯入」**
4. **等待處理完成**

## 匯入結果說明

### 成功匯入 ✅

```
┌────────────────────────────────────┐
│ ✓ 匯入完成                         │
│ ✓ 成功: 3 筆 / ✗ 失敗: 0 筆       │
└────────────────────────────────────┘

頁面將在 3 秒後自動重新整理
```

### 部分失敗 ⚠️

```
┌────────────────────────────────────┐
│ ⚠ 匯入完成                         │
│ ✓ 成功: 2 筆 / ✗ 失敗: 1 筆       │
├────────────────────────────────────┤
│ ✗ 錯誤訊息：                       │
│ • 010600022500: 找不到盤點項目     │
└────────────────────────────────────┘
```

## Excel 檔案格式說明

### 必要欄位

| 欄位名稱 | 必填 | 說明 | 範例 | 樣式 |
|---------|------|------|------|------|
| 零件編號 | ✅ | 用於識別零件 | 030200332800 | 標準文字 |
| 零件名稱 | ❌ | 僅供參考 | 保護膜_50*50cm | 標準文字 |
| 單位 | ❌ | 僅供參考 | 個 | 置中對齊 |
| 系統數量 | ❌ | 僅供參考 | 100 | 靠右對齊 |
| 實盤數量 | ✅ | **需填寫** | 98 | 🟨黃色背景 |
| 備註 | ❌ | 異常說明 | 損壞2個 | 標準文字 |

### Excel 檔案特色

#### 1. 標題行樣式
- 背景色：藍色 (#4472C4)
- 文字：白色粗體
- 對齊：置中
- 框線：完整邊框

#### 2. 自動欄寬
```
零件編號：自動調整（約 15 字元寬）
零件名稱：自動調整（約 20-30 字元寬）
單位：自動調整（約 6 字元寬）
系統數量：自動調整（約 10 字元寬）
實盤數量：自動調整（約 10 字元寬）
備註：自動調整（最大 50 字元寬）
```

#### 3. 特殊標示
- 🟨 實盤數量空白時：黃色背景
- 📌 凍結首行：捲動時標題保持可見
- 📏 格線框線：每個儲存格都有邊框

## 匯入邏輯

### 1. 檔案驗證

```
檢查項目：
✓ 檔案是否為 Excel 格式 (.xlsx 或 .xls)
✓ 是否包含必要欄位（零件編號、實盤數量）
✓ 資料行是否完整
```

### 2. 資料處理

對每一筆資料：
1. 讀取第一個工作表
2. 根據零件編號查找零件
3. 查找該零件在此盤點中的項目
4. 更新實盤數量
5. 計算差異數量（實盤 - 系統）
6. 記錄盤點時間

### 3. 錯誤處理

可能的錯誤：
- ❌ 零件編號不存在
- ❌ 該零件不在此盤點清單中
- ❌ 實盤數量格式錯誤（非數字）
- ❌ 實盤數量欄位空白

## 常見問題

### Q1：為什麼改用 Excel 格式？

**A：** CSV 格式的問題：
- ❌ 編碼問題（中文亂碼）
- ❌ Excel 儲存後資料會跑掉
- ❌ 逗號分隔符問題
- ❌ 格式不穩定

**Excel 的優勢：**
- ✅ 不會有編碼問題
- ✅ 儲存後資料不會跑掉
- ✅ 支援樣式和格式
- ✅ 更直覺易用

### Q2：可以用舊的 .xls 格式嗎？

**A：** 可以！系統支援：
- ✅ .xlsx（推薦，Excel 2007 以後）
- ✅ .xls（舊版 Excel 格式）

但建議使用 .xlsx 格式。

### Q3：為什麼有些欄位是黃色的？

**A：** 黃色背景代表「待填寫」：
- 🟨 實盤數量欄位：需要您填寫
- 填寫後：黃色會消失（自動）
- 提示作用：避免遺漏

### Q4：可以修改零件編號嗎？

**A：** 不可以。零件編號用於識別，不能修改。
- ❌ 修改後系統找不到對應零件
- ❌ 會導致匯入失敗
- ✅ 如有錯誤，請在系統中修正後重新匯出

### Q5：可以增加或刪除行嗎？

**A：** 
- ✅ 可以刪除不需要盤點的行
- ❌ 不建議增加新行（系統找不到該零件）
- ✅ 如需新增零件，在盤點詳情頁面使用「新增盤點項目」

### Q6：匯入時提示「找不到盤點項目」

**A：** 可能原因：
1. 零件不屬於此盤點的倉庫
2. 盤點類型為「循環盤點」或「抽點」，此零件未被包含
3. 零件編號輸入錯誤或有空白字元

**解決方法：**
- 確認零件編號是否正確
- 檢查是否在盤點清單中
- 如需要，手動「新增盤點項目」

### Q7：實盤數量沒填會怎樣？

**A：** 
- 系統會跳過該行
- 不會更新該零件的盤點數量
- 不會顯示錯誤
- 建議：只保留已盤點的項目

### Q8：可以重複匯入嗎？

**A：** 可以！
- ✅ 重複匯入會覆蓋之前的數據
- ✅ 可以分批匯入
- ✅ 可以修正錯誤後重新匯入

## 實際範例

### 範例 1：全盤點 Excel 操作

**情境：** 主倉庫全盤點，500 個項目

**步驟：**
```
1. 點擊「匯出資料」
   → 下載：盤點清單_SC-20251015-1234.xlsx

2. 用 Excel 開啟
   → 看到 500 行盤點項目
   → 實盤數量欄位顯示黃色

3. 現場盤點並填寫
   → 逐行填入實盤數量
   → 異常情況記錄在備註

4. 儲存檔案（Ctrl+S）
   → 保持 .xlsx 格式

5. 點擊「匯入盤點結果」
   → 選擇檔案
   → 點擊「開始匯入」

6. 查看結果
   → ✓ 成功: 500 筆
   → 頁面自動重新整理
```

**時間：** 2-3 小時（盤點） + 10 秒（匯入）

### 範例 2：使用條碼掃描器

**情境：** 配合條碼掃描器快速盤點

**步驟：**
```
1. 匯出 Excel 盤點清單

2. 在 Excel 中：
   - 點選「實盤數量」第一個儲存格
   - 掃描條碼（自動定位到該零件）
   - 手動輸入數量
   - 按 Enter 移到下一個

3. 完成後儲存並匯入
```

### 範例 3：團隊分工盤點

**情境：** 3 人分工盤點

**步驟：**
```
1. 匯出完整 Excel 清單

2. 複製成 3 個檔案：
   - 盤點清單_A區.xlsx（人員 A）
   - 盤點清單_B區.xlsx（人員 B）
   - 盤點清單_C區.xlsx（人員 C）

3. 各自刪除不負責的項目

4. 分別盤點並填寫

5. 依序匯入 3 個檔案：
   - 第 1 人匯入 → 成功 150 筆
   - 第 2 人匯入 → 成功 180 筆
   - 第 3 人匯入 → 成功 170 筆
   
6. 全部完成！
```

## 進階技巧

### 1. Excel 快速鍵

```
Ctrl+Home：跳到第一個儲存格
Ctrl+End：跳到最後一個儲存格
Ctrl+↓：跳到下一個有資料的儲存格
Ctrl+F：搜尋零件編號
Alt+Enter：儲存格內換行（備註欄位）
```

### 2. 資料驗證

在 Excel 中設定：
```
選取「實盤數量」欄
→ 資料 → 資料驗證
→ 設定：整數，大於等於 0
→ 錯誤提示：「請輸入正整數」
```

### 3. 條件格式化

標示差異項目：
```
選取「實盤數量」欄
→ 常用 → 設定格式化的條件
→ 新增規則：= D2<>E2（系統數量≠實盤數量）
→ 格式：紅色文字
```

### 4. 公式輔助

增加差異欄：
```
在 G 欄加入公式：= E2-D2
自動計算差異
幫助快速檢查
```

## 總結

### ✅ Excel 格式的優點

1. **穩定可靠**
   - 不會有編碼問題
   - 資料不會跑掉
   - 格式保持穩定

2. **使用方便**
   - 直接用 Excel 編輯
   - 不需要轉換格式
   - 儲存後直接匯入

3. **功能豐富**
   - 支援格式化（顏色、邊框）
   - 欄位自動調整
   - 凍結首行方便查看

4. **視覺清楚**
   - 藍色標題行
   - 黃色待填欄位
   - 格線邊框

### 📋 操作流程總結

```
匯出 Excel → 填寫實盤數量 → 直接儲存 → 匯入系統
    ↓            ↓              ↓           ↓
  .xlsx        黃色欄位        Ctrl+S     自動處理
```

### ⚠️ 注意事項

- ✅ 保持 Excel 格式 (.xlsx)
- ✅ 不要修改零件編號
- ✅ 實盤數量必須為數字
- ✅ 保留標題行
- ❌ 不要另存為 CSV
- ❌ 不要改變欄位順序

現在您可以輕鬆使用 Excel 進行盤點了！


## 功能位置

**路徑：** 庫存管理 → 盤點管理 → 選擇盤點 → 盤點詳情

**按鈕位置：** 盤點明細卡片右上角

```
┌────────────────────────────────────────────┐
│ 盤點明細                                   │
│                  [匯入盤點結果] [匯出資料] │
├────────────────────────────────────────────┤
│ 盤點項目列表...                            │
└────────────────────────────────────────────┘
```

**顯示條件：** 只有「盤點中」狀態才會顯示匯入按鈕

## 完整操作流程

### 步驟 1：匯出盤點範本

1. 進入盤點詳情頁面
2. 點擊「匯出資料」按鈕
3. 下載 CSV 檔案

**檔案內容範例：**
```csv
零件編號,零件名稱,單位,系統數量,實盤數量,備註
030200332800,保護膜_50*50cm,個,100,,
0499002171,酒精清潔液_4000ml,瓶,50,,
010600022500,油漆刷_1",支,30,,
```

### 步驟 2：填寫盤點結果

1. **用 Excel 開啟下載的 CSV 檔案**
2. **填寫「實盤數量」欄位**
   - 這是唯一需要填寫的必填欄位
   - 填入實際盤點的數量

3. **填寫「備註」欄位（選填）**
   - 如有異常可以記錄
   - 例如：損壞、過期、位置錯誤等

**填寫範例：**
```csv
零件編號,零件名稱,單位,系統數量,實盤數量,備註
030200332800,保護膜_50*50cm,個,100,98,損壞2個
0499002171,酒精清潔液_4000ml,瓶,50,50,
010600022500,油漆刷_1",支,30,28,2支遺失
```

### 步驟 3：儲存 CSV 檔案

**重要！儲存時注意：**
- ✅ 檔案格式：CSV (逗號分隔) (*.csv)
- ✅ 編碼：UTF-8
- ⚠️ 不要另存為 Excel 格式 (.xlsx)
- ⚠️ 不要改變欄位順序

**Excel 儲存步驟：**
1. 點擊「檔案」→「另存新檔」
2. 選擇「CSV UTF-8 (逗號分隔) (*.csv)」
3. 點擊「儲存」
4. 如提示格式不相容，點擊「是」

### 步驟 4：上傳匯入

1. **點擊「匯入盤點結果」按鈕**
2. **選擇剛才儲存的 CSV 檔案**
3. **點擊「開始匯入」**
4. **等待處理完成**

## 匯入結果說明

### 成功匯入

```
┌────────────────────────────────────┐
│ ✓ 匯入完成                         │
│ 成功: 3 筆 / 失敗: 0 筆            │
└────────────────────────────────────┘

頁面將在 3 秒後自動重新整理
```

### 部分失敗

```
┌────────────────────────────────────┐
│ ⚠ 匯入完成                         │
│ 成功: 2 筆 / 失敗: 1 筆            │
├────────────────────────────────────┤
│ 錯誤訊息：                         │
│ • 010600022500: 找不到盤點項目     │
└────────────────────────────────────┘
```

## CSV 檔案格式說明

### 必要欄位

| 欄位名稱 | 必填 | 說明 | 範例 |
|---------|------|------|------|
| 零件編號 | ✅ | 用於識別零件 | 030200332800 |
| 實盤數量 | ✅ | 實際盤點數量 | 98 |
| 備註 | ❌ | 異常說明 | 損壞2個 |

### 支援的標題格式

系統支援中英文標題：

| 中文 | 英文 |
|------|------|
| 零件編號 | part_number |
| 零件名稱 | part_name |
| 單位 | unit |
| 系統數量 | system_quantity |
| 實盤數量 | counted_quantity |
| 備註 | notes |

**建議：** 使用匯出的 CSV 範本，確保格式正確

## 匯入邏輯

### 1. 檔案驗證

```
檢查項目：
✓ 檔案是否為 CSV 格式
✓ 是否包含必要欄位（零件編號、實盤數量）
✓ 資料行是否完整
```

### 2. 資料處理

對每一筆資料：
1. 根據零件編號查找零件
2. 查找該零件在此盤點中的項目
3. 更新實盤數量
4. 計算差異數量（實盤 - 系統）
5. 記錄盤點時間

### 3. 錯誤處理

可能的錯誤：
- ❌ 零件編號不存在
- ❌ 該零件不在此盤點清單中
- ❌ 實盤數量格式錯誤
- ❌ 檔案編碼錯誤

## 常見問題

### Q1：為什麼找不到匯入按鈕？

**A：** 檢查以下條件：
1. 盤點狀態是否為「盤點中」？
   - 「規劃中」：還沒開始，需先點擊「開始盤點」
   - 「已完成」：已結束，無法再匯入
2. 是否在盤點詳情頁面？
   - 需要進入具體的盤點才能看到

### Q2：匯入時提示「零件不在盤點清單中」

**A：** 可能原因：
1. 這個零件不屬於此盤點的倉庫
2. 盤點類型為「循環盤點」或「抽點」，此零件未被包含
3. 零件編號輸入錯誤

**解決方法：**
- 確認零件是否應該在此盤點中
- 如需要，在盤點詳情頁面手動「新增盤點項目」

### Q3：Excel 開啟 CSV 後中文亂碼怎麼辦？

**A：** 編碼問題：
1. 不要直接雙擊開啟 CSV
2. 在 Excel 中：
   - 點擊「資料」→「從文字/CSV」
   - 選擇檔案
   - 編碼選擇「UTF-8」
   - 點擊「載入」

### Q4：可以修改零件編號嗎？

**A：** 不可以。零件編號用於識別，不能修改。如果零件編號錯誤：
- 在原始系統中修正零件編號
- 重新匯出盤點範本
- 重新填寫

### Q5：可以只匯入部分零件嗎？

**A：** 可以。只需在 CSV 中保留要匯入的零件，刪除其他行即可。

### Q6：匯入後可以再次匯入嗎？

**A：** 可以。重複匯入會覆蓋之前的數據。

## API 端點

### 匯入盤點結果

```http
POST /api/inventory/stock-counts/{count_id}/items/update-by-part
Content-Type: application/json

{
    "part_number": "030200332800",
    "counted_quantity": 98,
    "notes": "損壞2個"
}
```

**回應：**
```json
{
    "success": true,
    "message": "Count item updated"
}
```

**錯誤回應：**
```json
{
    "error": "Part not found: 030200332800"
}
```

## 最佳實踐

### 1. 使用範本

✅ **建議：** 先匯出，再填寫
- 確保欄位正確
- 避免格式錯誤
- 包含所有應盤點項目

❌ **不建議：** 自己建立 CSV
- 容易遺漏欄位
- 格式可能不符

### 2. 分批匯入

對於大量盤點（超過 100 項）：
1. 分成多個 CSV 檔案
2. 每個檔案 50-100 項
3. 分別匯入
4. 降低錯誤風險

### 3. 驗證數據

匯入前：
- ✅ 檢查實盤數量是否合理
- ✅ 確認沒有空白或錯誤數據
- ✅ 備份原始 CSV（以防需要重新匯入）

### 4. 錯誤處理

如果匯入失敗：
1. 查看錯誤訊息
2. 修正 CSV 檔案
3. 只保留失敗的項目
4. 重新匯入

## 實際範例

### 範例 1：全盤點匯入

**情境：** 主倉庫全盤點，500 個項目

**步驟：**
```
1. 開始盤點
2. 匯出 CSV（500 項）
3. 列印盤點清單
4. 現場盤點
5. 在 Excel 填寫實盤數量
6. 儲存 CSV
7. 匯入系統
8. 檢查差異報告
```

**時間：** 約 2-3 小時（現場盤點） + 5 分鐘（匯入）

### 範例 2：循環盤點匯入

**情境：** 每周盤點 A 類零件，50 個項目

**步驟：**
```
1. 建立循環盤點
2. 開始盤點
3. 匯出 CSV（50 項）
4. 快速盤點
5. 立即填寫 CSV
6. 匯入系統
7. 完成盤點
```

**時間：** 約 30 分鐘（盤點 + 匯入）

### 範例 3：抽點匯入

**情境：** 稽核抽查 20 個項目

**步驟：**
```
1. 建立抽點
2. 開始盤點
3. 匯出 CSV（20 項）
4. 現場抽查
5. 手機填寫數據（使用 Office App）
6. 儲存並匯入
7. 立即查看差異
```

**時間：** 約 15 分鐘

## 進階功能

### 1. 使用程式處理 CSV

對於大量數據，可以使用 Python 等程式：

```python
import pandas as pd

# 讀取盤點資料
df = pd.read_csv('count_data.csv')

# 批量處理（例如：批次調整）
df['實盤數量'] = df['系統數量'] - 2  # 全部減 2

# 儲存
df.to_csv('count_data_modified.csv', index=False, encoding='utf-8-sig')
```

### 2. 整合其他系統

如果有其他庫存系統：
1. 從其他系統匯出數據
2. 轉換為本系統 CSV 格式
3. 匯入本系統

### 3. 條碼掃描整合

使用條碼掃描器配合 Excel：
1. 掃描零件條碼（自動填入零件編號）
2. 手動輸入數量
3. 批量處理後匯入

## 總結

匯入盤點結果功能讓您可以：
- ✅ 離線填寫盤點數據
- ✅ 使用熟悉的 Excel 介面
- ✅ 批量處理大量盤點
- ✅ 減少逐筆輸入的時間
- ✅ 支援團隊協作（分工盤點）

**關鍵步驟：**
1. 匯出範本
2. 填寫實盤數量
3. 儲存為 UTF-8 CSV
4. 上傳匯入
5. 檢查結果

**注意事項：**
- ⚠️ 只有「盤點中」狀態才能匯入
- ⚠️ 確保 CSV 編碼為 UTF-8
- ⚠️ 零件編號必須正確
- ⚠️ 實盤數量必須為數字

現在您可以輕鬆匯入大量盤點結果了！
