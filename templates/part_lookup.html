{% extends "base.html" %}

{% block title %}é›¶ä»¶æŸ¥è©¢ - äº”é‡‘é›¶ä»¶åº«å­˜ç®¡ç†ç³»çµ±{% endblock %}

{% block extra_css %}
<style>
    .part-info {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
    }
    .order-history {
        max-height: 300px;
        overflow-y: auto;
    }
    #scanner-container {
        display: none;
        margin-top: 15px;
    }
    
    #scanner-video-wrapper {
        position: relative;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    #scanner-video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #scanner-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    /* æƒæç„æº–æ¡† */
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }
    
    .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 50%;
        border: 3px solid #00ff00;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            border-color: #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 20px #00ff00;
        }
        50% {
            border-color: #00cc00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 30px #00cc00;
        }
    }
    
    /* æƒæç·šå‹•ç•« */
    .scanner-line {
        position: absolute;
        left: 15%;
        right: 15%;
        height: 3px;
        background: linear-gradient(to right, transparent, #00ff00, transparent);
        box-shadow: 0 0 10px #00ff00;
        animation: scan 2s linear infinite;
    }
    
    @keyframes scan {
        0% {
            top: 25%;
        }
        100% {
            top: 75%;
        }
    }
    
    /* è§’è½æ¨™è¨˜ */
    .corner {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 4px solid #00ff00;
    }
    
    .corner.top-left {
        top: 25%;
        left: 15%;
        border-right: none;
        border-bottom: none;
    }
    
    .corner.top-right {
        top: 25%;
        right: 15%;
        border-left: none;
        border-bottom: none;
    }
    
    .corner.bottom-left {
        bottom: 25%;
        left: 15%;
        border-right: none;
        border-top: none;
    }
    
    .corner.bottom-right {
        bottom: 25%;
        right: 15%;
        border-left: none;
        border-top: none;
    }
    
    /* æç¤ºæ–‡å­— */
    .scanner-hint {
        position: absolute;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        white-space: nowrap;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    /* åµæ¸¬åˆ°æ¢ç¢¼æ™‚çš„è¦–è¦ºå›é¥‹ */
    .scanner-frame.detected {
        border-color: #ff0000;
        animation: flash 0.5s ease-in-out;
    }
    
    @keyframes flash {
        0%, 100% {
            border-color: #00ff00;
        }
        50% {
            border-color: #ffff00;
            box-shadow: 0 0 0 9999px rgba(255, 255, 0, 0.2), 0 0 40px #ffff00;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-search me-2"></i>é›¶ä»¶æŸ¥è©¢</h2>
        <p class="text-muted">è¼¸å…¥é›¶ä»¶ç·¨è™Ÿæˆ–ä½¿ç”¨æ¢ç¢¼æƒæå™¨æŸ¥è©¢é›¶ä»¶è³‡è¨Šã€‚</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æœå°‹é›¶ä»¶</h5>
            </div>
            <div class="card-body">
                <form id="searchForm">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="partNumber" placeholder="è¼¸å…¥é›¶ä»¶ç·¨è™Ÿ">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> æŸ¥è©¢
                        </button>
                    </div>
                </form>
                
                <button class="btn btn-secondary mb-3" id="toggleScanner">
                    <i class="fas fa-camera me-1"></i>é–‹å•Ÿæ¢ç¢¼æƒæ
                </button>
                
                <div id="scanner-container">
                    <div id="scanner-video-wrapper">
                        <video id="scanner-video" autoplay playsinline></video>
                        <canvas id="scanner-canvas"></canvas>
                        
                        <!-- æƒæç„æº–æ¡†è¦†è“‹å±¤ -->
                        <div class="scanner-overlay">
                            <div class="scanner-frame" id="scannerFrame">
                                <!-- æƒæç·š -->
                                <div class="scanner-line"></div>
                            </div>
                            
                            <!-- å››å€‹è§’è½æ¨™è¨˜ -->
                            <div class="corner top-left"></div>
                            <div class="corner top-right"></div>
                            <div class="corner bottom-left"></div>
                            <div class="corner bottom-right"></div>
                            
                            <!-- æç¤ºæ–‡å­— -->
                            <div class="scanner-hint" id="scannerHint">
                                ğŸ“· è«‹å°‡æ¢ç¢¼å°æº–æ–¹æ¡†å…§
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <button class="btn btn-danger" id="stopScanner">
                            <i class="fas fa-times me-1"></i>é—œé–‰æƒæå™¨
                        </button>
                        <button class="btn btn-info ms-2" id="switchCamera">
                            <i class="fas fa-sync-alt me-1"></i>åˆ‡æ›ç›¸æ©Ÿ
                        </button>
                    </div>
                    
                    <div id="scanner-status" class="alert alert-info mt-2" style="display: none;">
                        æ­£åœ¨æº–å‚™ç›¸æ©Ÿ...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div id="results" style="display: none;">
            <!-- æœå°‹çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        
        <div id="loading" style="display: none;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨æŸ¥è©¢é›¶ä»¶è³‡è¨Š...</p>
            </div>
        </div>
        
        <div id="error" style="display: none;">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="error-message">æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤</span>
            </div>
        </div>
    </div>
</div>

<!-- ä¸‹å–®æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å»ºç«‹è¨‚å–®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <input type="hidden" id="orderPartNumber">
                    <div class="mb-3">
                        <label for="orderQuantity" class="form-label">è¨‚è³¼æ•¸é‡</label>
                        <input type="number" class="form-control" id="orderQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="orderLocation" class="form-label">ç›®æ¨™å„²ä½</label>
                        <select class="form-select" id="orderLocation" required>
                            <option value="">è«‹é¸æ“‡å„²ä½</option>
                        </select>
                        <small class="text-muted">é¸æ“‡é›¶ä»¶æ‡‰è£œè²¨çš„å„²ä½</small>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            é›¶ä»¶ï¼š<span id="orderPartName"></span><br>
                            å–®ä½ï¼š<span id="orderPartUnit"></span>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="submitOrder">ç¢ºèªè¨‚è³¼</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/vendor/zxing-browser.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/part_lookup.js') }}"></script>
{% endblock %}
