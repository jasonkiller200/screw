{% extends "base.html" %}

{% block title %}審查登記 - 週期訂單管理{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('web.index') }}">首頁</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('weekly_order.weekly_orders') }}">週期訂單管理</a></li>
                    <li class="breadcrumb-item active">審查登記</li>
                </ol>
            </nav>
            <h2><i class="fas fa-clipboard-check text-primary"></i> 審查登記</h2>
            <p class="text-muted">審查 {{ cycle.cycle_name }} 的申請項目</p>
        </div>
    </div>

    <!-- 週期資訊與統計 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-calendar-alt me-2"></i>週期資訊</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>週期名稱：</strong>{{ cycle.cycle_name }}</p>
                            <p class="mb-1"><strong>截止時間：</strong>{{ cycle.deadline.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p class="mb-0">
                                <strong>狀態：</strong>
                                <span class="badge bg-{{ 'warning' if cycle.status == 'registration' else 'info' if cycle.status == 'review' else 'success' }}">
                                    {{ {'registration': '申請中', 'review': '審查中', 'completed': '已完成'}[cycle.status] }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>建立時間：</strong>{{ cycle.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p class="mb-1"><strong>總申請數：</strong>{{ registrations|length }} 項</p>
                            <p class="mb-0"><strong>待審查：</strong>{{ registrations|selectattr('status', 'equalto', 'registered')|list|length }} 項</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-1"></i>審查統計</h6>
                </div>
                <div class="card-body p-3">
                    {% set pending_count = registrations|selectattr('status', 'equalto', 'registered')|list|length %}
                    {% set approved_count = registrations|selectattr('status', 'equalto', 'approved')|list|length %}
                    {% set rejected_count = registrations|selectattr('status', 'equalto', 'rejected')|list|length %}
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-warning">
                                <i class="fas fa-clock fa-2x"></i>
                                <p class="mb-0 mt-1 small"><strong>{{ pending_count }}</strong><br>待審查</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-success">
                                <i class="fas fa-check-circle fa-2x"></i>
                                <p class="mb-0 mt-1 small"><strong>{{ approved_count }}</strong><br>已通過</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-danger">
                                <i class="fas fa-times-circle fa-2x"></i>
                                <p class="mb-0 mt-1 small"><strong>{{ rejected_count }}</strong><br>已拒絕</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工具列 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                    <label class="btn btn-outline-secondary" for="filterAll">全部 ({{ registrations|length }})</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="registered">
                    <label class="btn btn-outline-warning" for="filterPending">待審查 ({{ pending_count }})</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterApproved" value="approved">
                    <label class="btn btn-outline-success" for="filterApproved">已通過 ({{ approved_count }})</label>
                    
                    <input type="radio" class="btn-check" name="statusFilter" id="filterRejected" value="rejected">
                    <label class="btn btn-outline-danger" for="filterRejected">已拒絕 ({{ rejected_count }})</label>
                </div>
                
                <div>
                    {% if approved_count > 0 %}
                    <a href="{{ url_for('weekly_order.export_excel', cycle_id=cycle.id) }}" class="btn btn-success">
                        <i class="fas fa-file-excel me-1"></i>匯出 Excel ({{ approved_count }}項)
                    </a>
                    {% endif %}
                    <button class="btn btn-primary" onclick="batchApprove()">
                        <i class="fas fa-check-double me-1"></i>批量通過
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 申請項目清單 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    {% if registrations %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>品號</th>
                                    <th>品名</th>
                                    <th>規格</th>
                                    <th>數量</th>
                                    <th>單位</th>
                                    <th>類型</th>
                                    <th>申請人</th>
                                    <th>申請時間</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                <tr class="registration-row" data-status="{{ registration.status }}">
                                    <td>
                                        {% if registration.status == 'registered' %}
                                        <input type="checkbox" class="form-check-input registration-checkbox" 
                                               value="{{ registration.id }}">
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ registration.part_number }}</strong></td>
                                    <td>{{ registration.part_name }}</td>
                                    <td>{{ registration.specifications or '-' }}</td>
                                    <td class="text-end">{{ registration.quantity }}</td>
                                    <td>{{ registration.unit }}</td>
                                    <td>
                                        {% if registration.priority == 'urgent' %}
                                        <span class="badge bg-danger">緊急申請</span>
                                        {% else %}
                                        <span class="badge bg-info">一般申請</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ registration.applicant_name }}</td>
                                    <td>{{ registration.created_at.strftime('%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if registration.status == 'registered' %}
                                        <span class="badge bg-warning">待審查</span>
                                        {% elif registration.status == 'approved' %}
                                        <span class="badge bg-success">已通過</span>
                                        {% elif registration.status == 'rejected' %}
                                        <span class="badge bg-danger">已拒絕</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewDetails({{ registration.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if registration.status == 'registered' %}
                                            <button class="btn btn-success btn-sm" onclick="reviewRegistration({{ registration.id }}, 'approved')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="reviewRegistration({{ registration.id }}, 'rejected')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">尚無申請項目</h5>
                        <p class="text-muted">本週期尚未收到任何申請登記</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 返回按鈕 -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('weekly_order.weekly_orders') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>返回週期管理
            </a>
        </div>
    </div>
</div>

<!-- 詳細資訊模態 -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">申請詳細資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- 動態載入內容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 拒絕原因模態 -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">拒絕申請</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectReason" class="form-label">拒絕原因 <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="rejectReason" rows="3" required 
                              placeholder="請說明拒絕此申請的原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">確認拒絕</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentRegistrationId = null;

// 篩選功能
document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const status = this.value;
        const rows = document.querySelectorAll('.registration-row');
        
        rows.forEach(row => {
            if (status === 'all' || row.dataset.status === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

// 全選功能
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.registration-checkbox:not([style*="display: none"])');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// 查看詳細資訊
function viewDetails(registrationId) {
    fetch(`/weekly_orders/registration/${registrationId}`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本資訊</h6>
                        <table class="table table-sm">
                            <tr><td><strong>品號：</strong></td><td>${data.part_number}</td></tr>
                            <tr><td><strong>品名：</strong></td><td>${data.part_name}</td></tr>
                            <tr><td><strong>規格：</strong></td><td>${data.specifications || '-'}</td></tr>
                            <tr><td><strong>物料性質：</strong></td><td>${data.material_nature || '-'}</td></tr>
                            <tr><td><strong>種類：</strong></td><td>${data.category || '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>數量與時間</h6>
                        <table class="table table-sm">
                            <tr><td><strong>數量：</strong></td><td>${data.quantity} ${data.unit}</td></tr>
                            <tr><td><strong>需用日期：</strong></td><td>${data.required_date || '-'}</td></tr>
                            <tr><td><strong>申請時間：</strong></td><td>${new Date(data.created_at).toLocaleString('zh-TW')}</td></tr>
                            <tr><td><strong>用途備註：</strong></td><td>${data.purpose_notes || '-'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>申請人資訊</h6>
                        <table class="table table-sm">
                            <tr><td><strong>申請人：</strong></td><td>${data.applicant_name}</td></tr>
                            <tr><td><strong>申請單位：</strong></td><td>${data.department || '-'}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.review_notes ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>審查備註</h6>
                        <div class="alert alert-info">${data.review_notes}</div>
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('載入詳細資訊失敗');
        });
}

// 審查申請
function reviewRegistration(registrationId, action) {
    if (action === 'rejected') {
        currentRegistrationId = registrationId;
        new bootstrap.Modal(document.getElementById('rejectModal')).show();
        return;
    }
    
    // 直接通過
    submitReview(registrationId, action, '');
}

// 確認拒絕
function confirmReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        alert('請填寫拒絕原因');
        return;
    }
    
    submitReview(currentRegistrationId, 'rejected', reason);
    bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
}

// 提交審查結果
function submitReview(registrationId, action, notes) {
    fetch(`/weekly_orders/review/${registrationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 重新載入頁面以顯示更新結果
        } else {
            alert('審查失敗：' + (data.message || '未知錯誤'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('審查失敗，請稍後再試');
    });
}

// 批量通過
function batchApprove() {
    const checkedBoxes = document.querySelectorAll('.registration-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('請選擇要通過的申請項目');
        return;
    }
    
    if (!confirm(`確定要通過選中的 ${checkedBoxes.length} 個申請項目嗎？`)) {
        return;
    }
    
    const registrationIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
    
    fetch('/weekly_orders/batch_review', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            registration_ids: registrationIds,
            action: 'approved'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('批量審查失敗：' + (data.message || '未知錯誤'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('批量審查失敗，請稍後再試');
    });
}
</script>
{% endblock %}